window.Player=function(){var playerTemplate=document.querySelector("#playerTemplate").content.querySelector(".player"),header=document.querySelector("#playArena");var Player=function(playerName,playerID,playerScore){this.name=playerName;this.id=playerID;this.score=Number(playerScore);this.createPlayerDOM();this.bindEvents()};Player.prototype.createPlayerDOM=function(){this.playerDOM=playerTemplate.cloneNode(true);header.appendChild(this.playerDOM)};Player.prototype.bindEvents=function(){};Player.prototype.updateDOMScore=function(){this.playerDOM.innerText=this.score};Player.prototype.increaseScore=function(){this.updateDOMScore();this.score=1+this.score};return Player}();var Game=function(){};Game.prototype.otherPlayers={};Game.prototype.player={};Game.prototype.playerDetails={ACTIVE:false,playerName:"",playerScore:0,playerID:0};Game.prototype.init=function(){this.readGameFromStorage();if(!this.playerDetails.ACTIVE)this.promptPlayerName();this.saveGame2Storage();this.player=this.createPlayer(this.playerDetails.playerName,this.playerDetails.playerID,this.playerDetails.playerScore);this.saveGame2Remote("PLAYER_ONLINE")};Game.prototype.createPlayer=function(playerName,playerID,playerScore){return new Player(playerName,playerID,playerScore)};Game.prototype.bindEvents=function(){var playArena=document.getElementById("playArena"),resetBtn=document.getElementById("resetBtn");playArena.addEventListener("click",this.increaseScore.bind(this));resetBtn.addEventListener("click",this.resetGame.bind(this));connection.onmessage=this.messageReceived.bind(this)};Game.prototype.resetGame=function(){this.resetGameFromStorage();this.saveGame2Remote("PLAYER_DELETED");this.resetPlayerObj();this.init()};Game.prototype.resetGameFromStorage=function(){for(var prop in this.playerDetails){localStorage.setItem(prop,"")}};Game.prototype.resetPlayerObj=function(){for(var prop in this.playerDetails){this.playerDetails[prop]=""}};Game.prototype.promptPlayerName=function(){this.playerDetails.playerName=window.prompt();this.playerDetails.ACTIVE=true;this.playerDetails.playerID=Math.ceil(Math.random()*1e4);this.saveGame2Remote("NEW_PLAYER_CREATED")};Game.prototype.readGameFromStorage=function(){for(var prop in this.playerDetails){this.playerDetails[prop]=localStorage.getItem(prop)||this.playerDetails[prop]}};Game.prototype.saveGame2Storage=function(){for(var prop in this.playerDetails){localStorage.setItem(prop,this.playerDetails[prop])}};Game.prototype.saveGame2Remote=function(eventName){var payload={eventName:eventName,playerDetails:this.playerDetails};connection.post(JSON.stringify(payload))};Game.prototype.messageReceived=function(message){var messageObj=JSON.parse(message.data),playerDetails=JSON.parse(messageObj.playerDetails);console.log(messageObj);if(messageObj.eventName=="OTHER_PLAYER_SCORED"){if(!this.otherPlayers[playerDetails.playerID]){var oneAnotherPlayer=this.createPlayer(playerDetails.playerName,playerDetails.playerID,playerDetails.playerScore);this.otherPlayers[oneAnotherPlayer.id]=oneAnotherPlayer}else{this.otherPlayers[playerDetails.playerID].increaseScore()}console.log("other Players score received",messageObj.playerDetails+"   score "+messageObj.playerDetails)}};Game.prototype.increaseScore=function(){this.player.increaseScore();this.playerDetails.playerScore=this.player.score;this.saveGame2Storage();this.saveGame2Remote("PLAYER_SCORED_UP")};window.connection=function(){var connection=new WebSocket("ws://"+document.location.hostname+":8080","echo-protocol");connection.messages=[];connection.onopen=function(){console.info("SOCKET connection OPENED ")};connection.onmessage=function(e){console.info("SOCKET message RECEIVED ");judgeEvent(e.data)};connection.onclose=function(e){console.info("SOCKET connection CLOSED ",e.reason)};connection.onerror=function(err){console.error("SOCKET connection ERROR ",err.message,"Attempting to reconnect socket")};connection.post=function(message){this.queue(message);if(this.readyState===this.OPEN)this.sendAll()};connection.queue=function(message){this.messages.push(message)};connection.dequeue=function(){return this.messages.shift()};connection.sendAll=function(){while(this.messages.length!=0){this.send(this.dequeue())}};return connection}();var judgeEvent=function(){return function(message){var messageObj=JSON.parse(message),eventName=messageObj.eventName,playerDetails=messageObj.playerDetails;switch(eventName){case"NEW_PLAYER_CREATED":break;case"PLAYER_DELETED":break;case"PLAYER_ONLINE":console.log("PLAYER_ONLINE");break;case"PLAYER_SCORED_UP":console.log("PLAYER_SCORED_UP");break;case"OTHER_PLAYER_SCORED":console.log("OTHER_PLAYER_SCORED");break}}}();window.judgeEvent=judgeEvent;(function(){"use strict";var game=new Game;game.init();game.bindEvents()})();
